# Move /nix to a dedicated Btrfs subvolume

## Problem

Currently `/nix` lives inside the `@` root subvolume. This means:
- Btrfs snapshots of `@` include the entire Nix store (often 30-80 GB), making rollbacks slow and space-hungry
- Cannot exclude `/nix` from backups without path-based hacks (the store is fully reproducible)
- Cannot apply per-subvolume quotas or different mount options to `/nix`

## Scope

This issue covers **only the disko config change**. The actual data migration is a manual procedure that must be performed from a live USB — it cannot be done by an automated agent on a running system.

## Changes

### `hosts/thinkpad-x1-g3/disk-config.nix` -- add `@nix` subvolume

Add a new `@nix` subvolume entry next to the existing `@` and `@var-log`:

```nix
"@nix" = {
  mountpoint = "/nix";
  mountOptions = [
    "noatime"
    "compress=zstd:1"
  ];
};
```

The full `subvolumes` block should read:

```nix
subvolumes = {
  "@" = {
    mountpoint = "/";
    mountOptions = [
      "noatime"
      "compress=zstd:1"
    ];
  };
  "@nix" = {
    mountpoint = "/nix";
    mountOptions = [
      "noatime"
      "compress=zstd:1"
    ];
  };
  "@var-log" = {
    mountpoint = "/var/log";
    mountOptions = [
      "noatime"
      "compress=zstd:1"
    ];
  };
};
```

## Manual migration procedure (live USB required)

**Do NOT run these steps on a live system.** Boot from a NixOS installer USB first.

### 1. Snapshot root as safety net

```bash
mount -o subvolid=5 /dev/nvme1n1p6 /mnt
btrfs subvolume snapshot -r /mnt/@ /mnt/@-before-nix-move
```

### 2. Create the new subvolume

```bash
btrfs subvolume create /mnt/@nix
```

### 3. Copy data with reflinks (fast, no extra disk space)

```bash
cp -a --reflink=always /mnt/@/nix/* /mnt/@nix/
```

### 4. Remove old data

```bash
rm -rf /mnt/@/nix/*
```

### 5. Unmount

```bash
umount /mnt
```

### 6. Apply the disko config and rebuild

Boot normally. The new `@nix` subvolume mount entry will be generated by disko on the next `nix-switch`.

### 7. Verify

```bash
findmnt /nix          # should show subvol=/@nix
btrfs subvolume list / # should list @, @nix, @var-log
```

### 8. Clean up safety snapshot (once satisfied)

```bash
sudo mount -o subvolid=5 /dev/nvme1n1p6 /mnt
sudo btrfs subvolume delete /mnt/@-before-nix-move
sudo umount /mnt
```

## Rationale

- **Smaller snapshots**: `@` snapshots shrink dramatically without the Nix store, making rollbacks practical
- **Backup efficiency**: The reproducible store can be excluded at the subvolume level
- **Independent management**: Quotas, compression, or `nodatacow` can be tuned independently for `/nix`
- **Low risk**: Reflink copy is CoW — near-instant, uses no extra space. If anything goes wrong, the read-only snapshot provides a restore path

## Notes

- `compress=zstd:1` matches the existing root subvolume. The Nix store compresses very well (20-40% savings).
- After migration, the safety snapshot `@-before-nix-move` holds reflinks to the same extents, so it costs negligible extra space until data diverges.
- This is disko adoption mode only — never run `disko format` on this disk.
