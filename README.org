#+title: My NixOS config

** Overview
Multi-host NixOS configuration for my personal devices.

** Host specification

| Name           | Description               | Type    | Arch          |
| homelab        | Workstation               | Desktop | x86_64-linux  |
| thinkpad-x1-g3 | Thinkpad X1 Extreme Gen 3 | Laptop  | x86_64-linux  |
| homeserver     | Raspberry Pi 4            | Server  | aarch64-linux |

*** homeserver services
- [[https://nextcloud.com/][Nextcloud]] - File sync, calendar, contacts
- [[https://www.home-assistant.io/][Home Assistant]] - Home automation
- [[https://github.com/0xERR0R/blocky][Blocky]] - DNS ad blocker
- [[https://calibre-ebook.com/][Calibre]] - E-book library server
- [[https://tailscale.com/][Tailscale]] - VPN with HTTPS reverse proxy via Traefik

*** thinkpad-x1-g3 services
- [[https://traefik.io/][Traefik]] - Local HTTPS reverse proxy for Docker-based development
- [[https://thekelleys.org.uk/dnsmasq/doc.html][dnsmasq]] - Local DNS for =.test= and =.loc= development domains

** Usage

*** Local Rebuilds

Enter the development shell, then use the provided commands:

#+begin_src bash
# Enter development shell
nix develop

# Rebuild NixOS system configuration
nix-switch

# Rebuild home-manager configuration
home-switch
#+end_src

*** Remote Deployment

Deploy to homeserver from thinkpad (builds locally, deploys remotely):

#+begin_src bash
nixos-rebuild switch --flake ".#homeserver" \
  --target-host piotr@homeserver \
  --build-host localhost
#+end_src

** Remote Builds

The homeserver (aarch64) delegates builds to thinkpad-x1-g3 (x86_64) using distributed builds with QEMU emulation.

- A =builder= user on thinkpad accepts SSH connections from homeserver
- The builder SSH key is managed via sops-nix and deployed to =/etc/nix/builder_key=
- Thinkpad is configured as a trusted builder in homeserver's nix settings

** Secrets Management

Secrets are managed via [[https://github.com/Mic92/sops-nix][sops-nix]] with age encryption. Encrypted secrets are stored in the private repository (=nix-config-private=).

*** Key Types by Host

- *homeserver*: Uses SSH host key (=/etc/ssh/ssh_host_ed25519_key=)
- *thinkpad-x1-g3*: Uses standalone age key (=/var/lib/sops-nix/key.txt=)

*** Editing Secrets

#+begin_src bash
cd ~/development/nix-config-private
sops secrets/homeserver.yaml
#+end_src

** Roadmap
- [ ] Add declarative disk partitioning with [[https://github.com/nix-community/disko][Disko]].

** Resources
- [[https://nix.dev/][Official Nix Documentation]]
  - [[https://nix.dev/guides/best-practices][Best practices]]

** Acknowledgements

- [[https://github.com/EmergentMind/nix-config][EmergentMind]] - For the inspiration and the initial structure of the configuration.
